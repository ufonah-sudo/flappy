/**
 * api.js - –ú–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º (—Å–µ—Ä–≤–µ—Ä–æ–º)
 */

// –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ SDK Telegram WebApp –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
const tg = window.Telegram?.WebApp;

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
const API_BASE = '/api';

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
 */
function getInitData() {
    try {
        // –ï—Å–ª–∏ SDK –¥–æ—Å—Ç—É–ø–Ω–æ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
        if (tg && tg.initData) return tg.initData;
        // –ï—Å–ª–∏ SDK –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö–µ—à–∞ URL (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        const hash = window.location.hash.slice(1);
        // –ï—Å–ª–∏ —Ö–µ—à —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–∞—Ä—Å–∏–º –µ–≥–æ
        if (hash) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const params = new URLSearchParams(hash);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ tgWebAppData –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            return params.get('tgWebAppData') || "";
        }
    } catch (e) {
        // –í—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å, –µ—Å–ª–∏ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å
        console.warn("‚ö†Ô∏è [API] InitData check failed:", e);
    }
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ —Ñ–æ–ª–±—ç–∫
    return "";
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —è–¥—Ä–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ fetch
 */
export async function apiRequest(endpoint, method = 'POST', extraData = {}) {
    // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂—É—é —Å—Ç—Ä–æ–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    const initData = getInitData();
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π URL (–±–∞–∑–∞ + —ç–Ω–¥–ø–æ–∏–Ω—Ç)
    const url = `${API_BASE}/${endpoint}`;

    // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–∞—Ä—à—Ä—É—Ç –∏ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞)
    console.log(`[üöÄ API REQUEST] ${url}`, extraData);

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–º–µ–Ω–æ–π –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const controller = new AbortController();
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ–ª—á–∏—Ç 10 —Å–µ–∫, –∑–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    try {
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å
        const response = await fetch(url, {
            method: method, // –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ (POST)
            headers: { 
                'Content-Type': 'application/json', // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —à–ª–µ–º JSON
                'Cache-Control': 'no-cache' // –ó–∞–ø—Ä–µ—â–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
            },
            body: JSON.stringify({
                initData: initData, // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
                ...extraData // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
            }),
            signal: controller.signal // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª –æ—Ç–º–µ–Ω—ã –∫ fetch
        });

        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è
        clearTimeout(timeoutId);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª "–£—Å–ø–µ—à–Ω–æ, –Ω–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç"
        if (response.status === 204) return { success: true };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
        const contentType = response.headers.get("content-type");
        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª JSON, –ø–∞—Ä—Å–∏–º –µ–≥–æ
        if (contentType && contentType.includes("application/json")) {
            // –û–∂–∏–¥–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –æ–±—ä–µ–∫—Ç
            const responseData = await response.json();
            
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –Ω–µ 2xx, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            if (!response.ok) {
                throw new Error(responseData.error || responseData.message || `Status: ${response.status}`);
            }
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å—Ç—ã–π –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
            return responseData;
        } 
        
        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, —á–∏—Ç–∞–µ–º –µ–≥–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        const text = await response.text();
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å –ø–µ—Ä–≤—ã–º–∏ 100 —Å–∏–º–≤–æ–ª–∞–º–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞
        throw new Error(text.slice(0, 100) || `Server Error ${response.status}`);

    } catch (error) {
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –≤ —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏
        clearTimeout(timeoutId);
        // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
        console.error(`[‚ùå API ERROR] /${endpoint}:`, error.message);
        // –í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º success: false –∏ error: —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –±–∞–≥, –∫–æ–≥–¥–∞ alert –ø–æ–∫–∞–∑—ã–≤–∞–ª –ø—Ä–æ—Å—Ç–æ "true"
        return { success: false, error: error.message };
    }
}

// --- –°–ï–ö–¶–ò–Ø: –ü–†–û–§–ò–õ–¨ –ò –°–û–°–¢–û–Ø–ù–ò–ï ---

/**
 * –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
 */
export async function authPlayer(startParam, initDataString) { // <-- –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç initDataString
    // –®–ª–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/auth —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    return await apiRequest('auth', 'POST', { 
        startParam, 
        initData: initDataString // <-- –ü–µ—Ä–µ–¥–∞–µ–º initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    });
}

/**
 * –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–Ω–µ—Ç
 */
export async function fetchBalance() {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏–µ get_user
    const data = await apiRequest('auth', 'POST', { action: 'get_user' }); 
    // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
    if (data.error || !data.user) return 0;
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ –º–æ–Ω–µ—Ç, –µ—Å–ª–∏ –æ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    return typeof data.user.coins === 'number' ? data.user.coins : 0;
}

/**
 * –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
 */
export async function syncState(state) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    return await apiRequest('auth', 'POST', { 
        action: 'sync_state', // –ò–º—è –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
        coins: state.coins, // –¢–µ–∫—É—â–∏–µ –º–æ–Ω–µ—Ç—ã
        crystals: state.crystals, // –¢–µ–∫—É—â–∏–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã
        powerups: state.powerups, // –û–±—ä–µ–∫—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
        inventory: state.inventory || [] // –ú–∞—Å—Å–∏–≤ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    });
}

/**
 * –ü—Å–µ–≤–¥–æ–Ω–∏–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å main.js
 */
export const updateUserData = syncState;

// --- –°–ï–ö–¶–ò–Ø: –≠–ö–û–ù–û–ú–ò–ö–ê (–ú–û–ù–ï–¢–´ –ò –ú–ê–ì–ê–ó–ò–ù) ---

/**
 * –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ TON
 */
export async function buyCoins(amount) {
    // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    return await apiRequest('coins', 'POST', { action: 'buy_coins', amount: amount });
}

/**
 * –ü–æ–∫—É–ø–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–Ω–µ—Ç—ã
 */
export async function buyItem(itemType) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'shield') –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    return await apiRequest('coins', 'POST', { 
        action: 'buy_item', 
        item: itemType 
    });
}

/**
 * –°–ø–∏—Å–∞–Ω–∏–µ –º–æ–Ω–µ—Ç –∑–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ
 */
export async function spendCoin() {
    // –ó–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É –º–æ–Ω–µ—Ç –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —Ä–µ–≤–∞–π–≤
    const data = await apiRequest('coins', 'POST', { action: 'spend_revive' }); 
    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if (data && !data.error && typeof data.newBalance === 'number') {
        return data.newBalance; 
    }
    // –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
    return { error: true };
}

// --- –°–ï–ö–¶–ò–Ø: –†–ï–ö–û–†–î–´ –ò –°–û–¶–ò–ê–õ–ö–ê ---

/**
 * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –æ—á–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
 * mode –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'classic', –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å 'arcade'
 */
export async function saveScore(score, mode = 'classic') {
    // –ó–∞—â–∏—Ç–∞: –Ω–µ —à–ª–µ–º –∑–∞–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ —Å—á–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
    if (score < 0) return { success: false };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã –∏ –†–ï–ñ–ò–ú
    return await apiRequest('scores', 'POST', { 
        action: 'save_score', 
        score: score,
        mode: mode 
    });
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¢–û–ü-–∏–≥—Ä–æ–∫–æ–≤
 */
export async function getLeaderboard() {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ —É —Å–µ—Ä–≤–µ—Ä–∞
    const data = await apiRequest('scores', 'POST', { action: 'get_leaderboard' });
    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ (–¥–∞–∂–µ –ø—É—Å—Ç–æ–π), —á—Ç–æ–±—ã UI –Ω–µ —Å–ª–æ–º–∞–ª—Å—è
    return (data && Array.isArray(data.leaderboard)) ? data.leaderboard : [];
}

/**
 * –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
 */
export async function getFriends() {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥—Ä—É–∑—å—è—Ö —á–µ—Ä–µ–∑ —ç–∫—à–µ–Ω get_friends
    const data = await apiRequest('auth', 'POST', { action: 'get_friends' });
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç –º–∞—Å—Å–∏–≤–∞
    return (data && Array.isArray(data.friends)) ? data.friends : [];

    
}

/**
 * –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞
 */
export async function claimFriendReward(friendId) { // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ auth.js —Å –¥–µ–π—Å—Ç–≤–∏–µ–º claim_friend
    return await apiRequest('auth', 'POST', { 
        action: 'claim_friend', 
        friend_id: friendId // –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
    });
}
